<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log Viewer</title>
    <script src="${alpineUri}" defer></script>
    <style>
      body {
        font-family: var(--vscode-font-family, Arial, sans-serif);
        font-size: var(--vscode-font-size, 14px);
        color: var(--vscode-editor-foreground, #333);
        background-color: var(--vscode-editor-background, #fff);
        margin: 0;
        padding: 20px;
      }

      /* Loading spinner */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-size: 18px;
      }

      .spinner {
        border: 4px solid var(--vscode-input-background, #f3f3f3);
        border-top: 4px solid var(--vscode-editorLineNumber-foreground, #ccc);
        border-radius: 50%;
        padding-right: 10px;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        color: var(--vscode-editor-foreground, #333);
        background-color: var(--vscode-editor-background, #fff);
      }

      th {
        text-align: left;
        padding: 8px;
        background-color: var(--vscode-sideBar-background, #ddd);
        border: 1px solid var(--vscode-editorLineNumber-foreground, #ccc);
      }

      td {
        padding: 8px;
        border: 1px solid var(--vscode-editorLineNumber-foreground, #ccc);
      }

      .controls {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pagination {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      input[type="text"] {
        padding: 5px;
        border: 1px solid var(--vscode-editorLineNumber-foreground, #ccc);
        border-radius: 4px;
        background-color: var(--vscode-input-background, #f3f3f3);
        color: var(--vscode-input-foreground, #333);
      }

      input[type="text"]:disabled {
        background-color: var(--vscode-input-disabledBackground, #f3f3f3);
        color: var(--vscode-input-disabledForeground, #aaa);
      }

      button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        background-color: var(--vscode-button-background, #007acc);
        color: var(--vscode-button-foreground, #fff);
        cursor: pointer;
      }

      button:disabled {
        background-color: var(--vscode-button-secondaryBackground, #aaa);
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        background-color: var(--vscode-button-hoverBackground, #005f9e);
      }
    </style>
  </head>
  <body>
    <div x-data="logViewer()" x-init="init()">
      <div>
        <form class="controls" @submit.prevent="applyFilters">
          <input x-bind:disabled="loading" type="text" placeholder="Timestamp" x-model="filters.timestamp" />
          <input x-bind:disabled="loading" type="text" placeholder="Severity" x-model="filters.severity" />
          <input x-bind:disabled="loading" type="text" placeholder="Message" x-model="filters.message" />
          <button x-bind:disabled="loading" @click="applyFilters()">Search</button>
        </form>
      </div>
      <div x-show="loading" class="loading">
        <div class="spinner"></div>
        <span>Loading logs...</span>
      </div>
      <table x-show="!loading">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Severity</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody x-show="hasNoLogs">
          <tr>
            <td style="text-align: center" colspan="3">No logs found.</td>
          </tr>
        </tbody>
        <tbody x-if="!hasNoLogs">
          <template x-for="(log, idx) in pageLogs" :key="idx">
            <tr>
              <td x-text="log.timestamp"></td>
              <td x-text="log.severity"></td>
              <td>
                <template x-if="indexToShow !== idx">
                  <span x-text="formatMessage(log.text)"></span>
                </template>
                <template x-if="indexToShow === idx">
                  <pre x-text="log.text"></pre>
                </template>
                <button @click="showDetails(idx)">Details</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
      <div class="pagination">
        <button @click="prevPage" x-bind:disabled="page === 1">Previous</button>
        <span x-text="`Page ${page} of ${totalPages}`"></span>
        <button @click="nextPage" x-bind:disabled="page === totalPages">Next</button>
      </div>
    </div>
    <script>
      function logViewer() {
        return {
          logs: [],
          filters: { timestamp: "", severity: "", message: "" },
          filteredLogs: [],
          loading: true,
          page: 1,
          pageSize: 50,
          indexToShow: null,
          get totalPages() {
            return Math.ceil(this.filteredLogs.length / this.pageSize);
          },
          get hasNoLogs() {
            return this.filteredLogs.length === 0;
          },
          get pageLogs() {
            const start = (this.page - 1) * this.pageSize;
            const end = start + this.pageSize;
            return this.filteredLogs.slice(start, end);
          },
          async init() {
            window.addEventListener("message", (event) => {
              const message = event.data;
              if (message.command === "loadLogs") {
                this.logs = message.logs;
                this.filteredLogs = [...this.logs];
                this.loading = false;
              }
            });
          },
          applyFilters() {
            this.filteredLogs = this.logs.filter((log) => {
              return (
                (!this.filters.timestamp || log.timestamp.includes(this.filters.timestamp)) &&
                (!this.filters.severity || log.severity.includes(this.filters.severity.toLocaleUpperCase())) &&
                (!this.filters.message || log.text.includes(this.filters.message))
              );
            });
            this.page = 1;
          },
          nextPage() {
            if (this.page < this.totalPages) {
              this.page++;
            }
          },
          prevPage() {
            if (this.page > 1) {
              this.page--;
            }
          },
          showDetails(idx) {
            if (this.indexToShow === idx) {
              this.indexToShow = null;
            } else {
              this.indexToShow = idx;
            }
          },
          formatMessage(message) {
            if (message.length > 100) {
              return message.substring(0, 100) + "...";
            } else {
              return message;
            }
          },
        };
      }
    </script>
  </body>
</html>
